<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∞ó‡±Å‡∞∞‡±Å‡∞µ‡±Å‡∞≤‡±Å ‡∞®‡∞ø‡∞Ç‡∞™‡∞ø‡∞® ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞æ‡∞µ‡∞≥‡∞ø</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="filledquestionnaire.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>
    <!-- Home Button -->
    <a href="teacher_dashboard_te.html" class="btn btn-primary home-button">‡∞π‡±ã‡∞Æ‡±ç</a>

    <div class="container-fluid mt-4">
        <!-- Page Title -->
        <br>
        <h1 id="pageTitle" class="text-center my-4">‡∞®‡∞ø‡∞Ç‡∞™‡∞ø‡∞® ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞æ‡∞µ‡∞≥‡∞ø</h1>

        <!--<h1 class="text-center my-4">‡∞ó‡±Å‡∞∞‡±Å‡∞µ‡±Å‡∞≤‡±Å ‡∞®‡∞ø‡∞Ç‡∞™‡∞ø‡∞® ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞æ‡∞µ‡∞≥‡∞ø</h1>-->
        <!-- Search Input -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø‡∞æ‡∞∞‡±ç‡∞•‡∞ø ‡∞™‡±á‡∞∞‡±Å‡∞§‡±ã ‡∞∂‡±ã‡∞ß‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø..." class="form-control">
            <i class="search-icon">üîç</i>
        </div>

        <!-- Student Buttons Container -->
        <div id="studentButtonsContainer" class="student-buttons text-center"></div>

        <!-- Modal Backdrop -->
        <div id="modalBackdrop" class="modal-backdrop"></div>

        <div id="studentModal" class="student-modal">
            <button class="btn-close-modal" onclick="closeModal()">&times;</button>
            <div id="studentModalContent" class="p-4"></div>
            <button id="downloadSnapshot" class="btn btn-primary mt-3" onclick="downloadSnapshot()">‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç</button>
        </div>
    </div>

    <script>
        // Firebase configuration remains unchanged
        const firebaseConfig = {
            apiKey: "AIzaSyC_8gFPJrjBhjs4Zj5YDyYcoZQjfl6Amr0",
            authDomain: "autism-evaluation-platform.firebaseapp.com",
            projectId: "autism-evaluation-platform",
            storageBucket: "autism-evaluation-platform",
            messagingSenderId: "748226978662",
            appId: "1:748226978662:web:cddef872e6bfc1fb131ea7",
            measurementId: "G-1TGEHTTJF4"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        //display username
        async function getUserName(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    return userData.name || userData.displayName || 'User';
                }
                return 'User';
            } catch (error) {
                console.error('Error fetching user name:', error);
                return 'User';
            }
        }
        // Function to display submissions as buttons and modal
        async function displaySubmissions(userId) {
            const studentButtonsContainer = document.getElementById('studentButtonsContainer');
            const modalBackdrop = document.getElementById('modalBackdrop');
            const studentModal = document.getElementById('studentModal');
            const studentModalContent = document.getElementById('studentModalContent');
            const searchInput = document.getElementById('searchInput');
             // Get and set user name in title
             const userName = await getUserName(userId);
            pageTitle.textContent = `${userName} ‡∞®‡∞ø‡∞Ç‡∞™‡∞ø‡∞® ‡∞™‡±ç‡∞∞‡∞∂‡±ç‡∞®‡∞æ‡∞µ‡∞≥‡∞ø`;

            try {
                // Fetch submissions
                const submissionsRef = db.collection('users').doc(userId).collection('submissions');
                const submissionsSnap = await submissionsRef.orderBy('submittedAt', 'desc').get();

                if (submissionsSnap.empty) {
                    studentButtonsContainer.innerHTML = '<p class="text-center text-danger">‡∞™‡±Å‡∞∞‡±ã‡∞ó‡∞§‡±Å‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å.</p>';
                    return;
                }

                const submissions = [];
                submissionsSnap.forEach(doc => {
                    const data = doc.data();
                    if (!data.scores || Object.keys(data.scores).length === 0) return;
                    submissions.push({...data, id: doc.id});
                });

                // Create buttons and modal content for each student
                submissions.forEach((data, index) => {
                    const buttonId = `student-btn-${index}`;
                    
                    // Create student button
                    const buttonHTML = `
                        <button id="${buttonId}" class="btn" 
                                onclick="showStudentModal(${index})">
                            <strong>${data.studentName || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</strong>
                            <small>‡∞™‡±Å‡∞ü‡±ç‡∞ü‡∞ø‡∞® ‡∞§‡±á‡∞¶‡±Ä: ${data.studentDob || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</small>
                            <small>‡∞µ‡∞Ø‡∞∏‡±ç‡∞∏‡±Å: ${data.studentAge || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</small>
                        </button>
                    `;
                    studentButtonsContainer.insertAdjacentHTML('beforeend', buttonHTML);
                });

                // Search functionality
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const buttons = document.querySelectorAll('.student-buttons .btn');
                    
                    buttons.forEach(button => {
                        const studentName = button.querySelector('strong').textContent.toLowerCase();
                        button.style.display = studentName.includes(searchTerm) ? 'flex' : 'none';
                    });
                });

                // Store submissions in a global variable for modal access
                window.submissions = submissions;
            } catch (err) {
                console.error('Error fetching submissions:', err);
                studentButtonsContainer.innerHTML = `
                    <p class="text-center text-danger">
                        ‡∞™‡±Å‡∞∞‡±ã‡∞ó‡∞§‡±Å‡∞≤‡∞®‡±Å ‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç‡∞≤‡±ã ‡∞≤‡±ã‡∞™‡∞Ç. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡±á‡∞ú‡±Ä‡∞®‡∞ø ‡∞∞‡∞ø‡∞´‡±ç‡∞∞‡±Ü‡∞∑‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.
                    </p>
                `;
            }
        }

        // Function to show student modal
        function showStudentModal(index) {
            const modalBackdrop = document.getElementById('modalBackdrop');
            const studentModal = document.getElementById('studentModal');
            const studentModalContent = document.getElementById('studentModalContent');
            const data = window.submissions[index];
            
            const autismRangeTranslations = {
    "No Autism": "‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç ‡∞≤‡±á‡∞¶‡±Å",
    "Mild Autism": "‡∞∏‡±ç‡∞µ‡∞≤‡±ç‡∞™ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "Moderate Autism": "‡∞Æ‡∞ß‡±ç‡∞Ø‡∞∏‡±ç‡∞• ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "Severe Autism": "‡∞§‡±Ä‡∞µ‡±ç‡∞∞ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç ‡∞≤‡±á‡∞¶‡±Å": "‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç ‡∞≤‡±á‡∞¶‡±Å",
    "‡∞∏‡±ç‡∞µ‡∞≤‡±ç‡∞™ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç": "‡∞∏‡±ç‡∞µ‡∞≤‡±ç‡∞™ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡∞Æ‡∞ß‡±ç‡∞Ø‡∞∏‡±ç‡∞• ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç": "‡∞Æ‡∞ß‡±ç‡∞Ø‡∞∏‡±ç‡∞• ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡∞§‡±Ä‡∞µ‡±ç‡∞∞ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç": "‡∞§‡±Ä‡∞µ‡±ç‡∞∞ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡§ë‡§ü‡§ø‡§ú‡•ç‡§Æ ‡§®‡§π‡•Ä‡§Ç": "‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç ‡∞≤‡±á‡∞¶‡±Å",
    "‡§π‡§≤‡•ç‡§ï‡§æ ‡§ë‡§ü‡§ø‡§ú‡•ç‡§Æ": "‡∞∏‡±ç‡∞µ‡∞≤‡±ç‡∞™ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ë‡§ü‡§ø‡§ú‡•ç‡§Æ": "‡∞Æ‡∞ß‡±ç‡∞Ø‡∞∏‡±ç‡∞• ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç",
    "‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§ë‡§ü‡§ø‡§ú‡•ç‡§Æ": "‡∞§‡±Ä‡∞µ‡±ç‡∞∞ ‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç"
};
const scoreKeyTranslationsTelugu = {
    "cognitiveComponent": "‡∞ú‡±ç‡∞û‡∞æ‡∞® ‡∞≠‡∞æ‡∞ó‡∞Ç",
    "emotionalResponsiveness": "‡∞≠‡∞æ‡∞µ_‡∞™‡±ç‡∞∞‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å",
    "sensoryAspects": "‡∞∏‡∞Ç‡∞µ‡±á‡∞¶‡∞® ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞ø‡∞§ ‡∞Ö‡∞Ç‡∞∂‡∞æ‡∞≤‡±Å",
    "speechLanguageCommunication": "‡∞≠‡∞æ‡∞∑-‡∞Æ‡∞æ‡∞ü‡∞≤‡±Å",
    "socialRelationship": "‡∞∏‡∞æ‡∞Æ‡∞æ‡∞ú‡∞ø‡∞ï ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞æ‡∞≤‡±Å",
    "behaviourPatterns": "‡∞™‡±ç‡∞∞‡∞µ‡∞∞‡±ç‡∞§‡∞®‡∞æ ‡∞µ‡∞ø‡∞ß‡∞æ‡∞®‡∞æ‡∞≤‡±Å",
    "Unknown": "‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å" // Default for unexpected keys
};


            // Populate modal content
            studentModalContent.innerHTML = `
                <h2 class="text-primary mb-4">${data.studentName || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</h2>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>‡∞µ‡∞Ø‡∞∏‡±ç‡∞∏‡±Å:</strong> ${data.studentAge || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</p>
                        <p><strong>‡∞™‡±Å‡∞ü‡±ç‡∞ü‡∞ø‡∞® ‡∞§‡±á‡∞¶‡±Ä:</strong> ${data.studentDob || '‡∞§‡±Ü‡∞≤‡∞ø‡∞Ø‡∞¶‡±Å'}</p>
                        <p><strong>‡∞∏‡∞Æ‡∞∞‡±ç‡∞™‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞§‡±á‡∞¶‡±Ä:</strong> ${data.submittedAt.toDate().toLocaleString()}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±Å:</strong> ${data.totalScore}</p>
                        <p><strong>‡∞∂‡∞æ‡∞§‡∞Ç:</strong> ${data.percentageScore}%</p>
                        <p><strong>‡∞Ü‡∞ü‡∞ø‡∞ú‡∞Ç ‡∞™‡∞∞‡∞ø‡∞ß‡∞ø:</strong> ${autismRangeTranslations[data.autismRange]}</p>
                    </div>
                </div>
                <h4 class="mt-4 text-primary">‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç‡∞≤ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å</h4>
                <ul class="list-group">
                     ${Object.keys(data.scores).map(key => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                ${scoreKeyTranslationsTelugu[key] || key}
                <span class="badge bg-primary rounded-pill">${data.scores[key]}</span>
            </li>
        `).join('')}
                </ul>
            `;

            // Show modal and backdrop
            modalBackdrop.classList.add('show');
            studentModal.classList.add('show');
        }

        async function downloadSnapshot() {
    const studentModalContent = document.getElementById('studentModalContent');
    const data = window.submissions.find(submission => 
        submission.studentName === studentModalContent.querySelector('h2').textContent.trim()
    );
    const studentName = data ? data.studentName : 'student';
    const canvas = await html2canvas(studentModalContent);
    const link = document.createElement('a');
    link.download = `${studentName}-‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

        // Function to close modal
        function closeModal() {
            const modalBackdrop = document.getElementById('modalBackdrop');
            const studentModal = document.getElementById('studentModal');

            modalBackdrop.classList.remove('show');
            studentModal.classList.remove('show');
        }

        // Close modal when clicking outside
        document.getElementById('modalBackdrop').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                displaySubmissions(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
